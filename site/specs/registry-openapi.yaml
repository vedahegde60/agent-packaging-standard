openapi: 3.0.3
info:
  title: APS Registry API (draft)
  version: 0.1.0
  description: Minimal API for discovering, publishing, and pulling APS agents.
servers:
  - url: https://registry.example.com
paths:
  /v1/agents:
    get:
      summary: Search agents
      parameters:
        - in: query
          name: q
          schema: { type: string }
          description: Query string (id, name, tags)
        - in: query
          name: limit
          schema: { type: integer, default: 20, minimum: 1, maximum: 100 }
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  agents:
                    type: array
                    items:
                      $ref: '#/components/schemas/AgentSummary'
    post:
      summary: Publish agent metadata (manifest-first)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PublishRequest'
      responses:
        '201':
          description: Published
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublishResponse'
  /v1/agents/{id}:
    get:
      summary: Get agent by ID
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Agent detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentDetail'
        '404': { description: Not found }
  /v1/pull:
    get:
      summary: Pull manifest or package reference
      parameters:
        - in: query
          name: id
          required: true
          schema: { type: string }
        - in: query
          name: format
          schema:
            type: string
            enum: [manifest, package]
            default: manifest
      responses:
        '200':
          description: Manifest JSON or package URL
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PullResponse'
  /v1/tokens:
    post:
      summary: Exchange auth for a short-lived publish token (optional)
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                provider: { type: string, example: "github" }
                token: { type: string }
      responses:
        '200':
          description: Issue short-lived token
          content:
            application/json:
              schema:
                type: object
                properties:
                  token: { type: string }
components:
  schemas:
    AgentSummary:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
        version: { type: string }
        summary: { type: string }
        publisher: { type: string }
        updated_at: { type: string, format: date-time }
    AgentDetail:
      allOf:
        - $ref: '#/components/schemas/AgentSummary'
        - type: object
          properties:
            manifest: { type: object, additionalProperties: true }
            signatures:
              type: array
              items:
                $ref: '#/components/schemas/Signature'
    PublishRequest:
      type: object
      properties:
        manifest: { type: object, additionalProperties: true }
        provenance: { $ref: '#/components/schemas/Provenance' }
        signatures:
          type: array
          items: { $ref: '#/components/schemas/Signature' }
    PublishResponse:
      type: object
      properties:
        id: { type: string }
        version: { type: string }
        status: { type: string, example: "ok" }
    PullResponse:
      type: object
      properties:
        format: { type: string, enum: [manifest, package] }
        manifest: { type: object, additionalProperties: true }
        package_url: { type: string, nullable: true }
    Provenance:
      type: object
      properties:
        builder: { type: string }
        build_type: { type: string, example: "local|ci|reproducible" }
        materials:
          type: array
          items: { type: string, description: "Source URIs (git, tarball, etc.)" }
        invocation:
          type: object
          additionalProperties: true
        metadata:
          type: object
          properties:
            commit: { type: string }
            created_at: { type: string, format: date-time }
    Signature:
      type: object
      properties:
        alg: { type: string, example: "ed25519" }
        sig: { type: string, description: "base64 signature" }
        keyid: { type: string }

